<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Our Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.3/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #0d0d0d; /* Cyberpunk deep black theme */
    }
    #chat-container {
      width: 100%;
      max-width: 640px;
      margin: 0 auto;
      height: 100%;
    }
  </style>
</head>
<body class="text-white">
  <div class="min-h-screen flex flex-col items-center justify-center">
    <!-- Name Prompt Overlay -->
    <div id="namePrompt" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
      <div class="bg-gray-700 text-center p-8 rounded shadow-lg">
        <h2 class="mb-4 text-xl font-bold">Whatâ€™s your name?</h2>
        <input id="nameInput" type="text" class="text-black rounded p-2" placeholder="Enter your name..." />
        <button id="nameSubmit" class="bg-blue-500 rounded p-2 ml-2">Submit</button>
      </div>
    </div>

    <!-- Header -->
    <header class="w-full bg-blue-700 text-white py-4">
      <h1 class="text-center text-3xl font-bold">Our Chat</h1>
    </header>

    <!-- Chat Container -->
    <div id="chat-container" class="bg-gray-800 shadow-lg rounded-lg mt-5 flex-grow flex flex-col items-stretch p-6">
      
      <!-- Welcome + New Chat Button -->
      <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4">
        <div id="welcomeMessage" class="text-2xl mb-2 sm:mb-0">Welcome back!</div>
        <button id="newChatButton" class="bg-green-500 rounded py-2 px-4 font-bold sm:py-1 sm:px-2 self-end sm:self-auto">
          New Chat
        </button>
      </div>

      <!-- Chatbox -->
      <div id="chatbox" class="flex flex-col items-start overflow-y-auto flex-grow bg-deep-blue rounded p-3"></div>

      <!-- Message Input -->
      <div class="flex flex-row mt-5">
        <input class="shadow flex-grow rounded p-2 text-gray-800 bg-gray-600 placeholder-gray-400 focus:placeholder-transparent focus:text-white"
          id="messageInput" type="text" placeholder="Type your message..." />
        <button
          class="bg-electric-purple rounded py-2 px-4 text-white font-bold ml-2 focus:outline-none hover:bg-purple-700"
          id="sendButton">Send</button>
      </div>
    </div>
  </div>

  <script>
    const chatbox = document.getElementById("chatbox");
    const messageInput = document.getElementById("messageInput");
    const sendButton = document.getElementById("sendButton");
    const newChatButton = document.getElementById("newChatButton");
    const chatId = crypto.randomUUID();

    const namePrompt = document.getElementById("namePrompt");
    const nameInput = document.getElementById("nameInput");
    const nameSubmit = document.getElementById("nameSubmit");
    const welcomeMessage = document.getElementById("welcomeMessage");

    let receiving = false;
    const systemPrompt = "Yes, please generate the full project code based on the provided blueprint. Thank you!";

    function createMessageElement(text, alignment) {
      const messageElement = document.createElement("div");
      messageElement.className = `inline-block my-2.5 p-2.5 rounded border bg-gray-700 shadow-sm ${
        alignment === "left" ? "self-start" : "self-end"
      } text-white`;
      messageElement.textContent = text;
      return messageElement;
    }

    function connectWebSocket(message) {
      receiving = true;
      const url = "wss://backend.buildpicoapps.com/api/chatbot/chat";
      const websocket = new WebSocket(url);

      websocket.addEventListener("open", () => {
        websocket.send(
          JSON.stringify({
            chatId: chatId,
            appId: "southern-Republican",
            systemPrompt: systemPrompt,
            message: message,
          })
        );
      });

      const messageElement = createMessageElement("", "left");
      chatbox.appendChild(messageElement);

      websocket.onmessage = (event) => {
        messageElement.innerText += event.data;
        chatbox.scrollTo(0, chatbox.scrollHeight);
      };

      websocket.onclose = (event) => {
        if (event.code === 1000) {
          receiving = false;
        } else {
          messageElement.textContent += "Error getting response from server. Refresh the page and try again.";
          chatbox.scrollTo(0, chatbox.scrollHeight);
          receiving = false;
        }
      };
    }

    sendButton.addEventListener("click", () => {
      if (!receiving && messageInput.value.trim() !== "") {
        const messageText = messageInput.value.trim();
        messageInput.value = "";
        const messageElement = createMessageElement(messageText, "right");
        chatbox.appendChild(messageElement);
        chatbox.scrollTo(0, chatbox.scrollHeight);
        connectWebSocket(messageText);
      }
    });

    newChatButton.addEventListener("click", () => {
      chatbox.innerHTML = '';
    });

    messageInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter" && !receiving && messageInput.value.trim() !== "") {
        event.preventDefault();
        sendButton.click();
      }
    });

    // Submit name via click or Enter key
    function submitName() {
      const name = nameInput.value.trim();
      if (name) {
        localStorage.setItem('userName', name);
        welcomeMessage.textContent = `Welcome back, ${name}!`;
        namePrompt.classList.add('hidden');
      }
    }

    nameSubmit.addEventListener("click", submitName);

    nameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        submitName();
      }
    });

    // Show prompt or load saved name
    const storedName = localStorage.getItem('userName');
    if (!storedName) {
      namePrompt.classList.remove('hidden');
    } else {
      nameInput.value = storedName;
      welcomeMessage.textContent = `Welcome back, ${storedName}!`;
      namePrompt.classList.add('hidden');
    }
  </script>
</body>
</html>
